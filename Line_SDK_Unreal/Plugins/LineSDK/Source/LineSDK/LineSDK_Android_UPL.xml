<?xml version="1.0" encoding="utf-8"?>
<root xmlns:android="http://schemas.android.com/apk/res/android">
    
    <!-- init section is always evaluated once per architecture -->
    <init>
        <setStringFromProperty result="ChannelID" ini="Engine" section="/Script/LineSDK.LineSDKSettings" property="ChannelID" default=""/>
<!--        <setStringFromProperty result="UniversalLinkURL" ini="Engine" section="/Script/LineSDK.LineSDKSettings" property="UniversalLinkURL" default=""/>-->
        
        <log text="[LineSDK] initialization: ChannelID={$S(ChannelID)}"/>
    </init>
    
    <prebuildCopies>
        <copyDir src="$S(PluginDir)/../ThirdParty/Android/linesdk-android-unreal" dst="$S(BuildDir)/src" />
    </prebuildCopies>
    
    <AARImports>
        <insertValue value="repository $S(PluginDir)/../ThirdParty/Android/linesdk-android-unreal-wrapper"/>
        <insertNewline/>
        <insertValue value="co.pokeum.linesdk.unrealwrapper,linesdk-android-unreal-wrapper,1.0.0" />
        <insertNewline/>
    </AARImports>

    <buildGradleAdditions>
        <insert>
            android {
                compileOptions {
                    sourceCompatibility JavaVersion.VERSION_1_8
                    targetCompatibility JavaVersion.VERSION_1_8
                }
            }
        </insert>
    </buildGradleAdditions>
    
    <androidManifestUpdates>
        <addPermission android:name="android.permission.INTERNET" />
        <addElements tag="application">
            <!-- Meta data for Line SDK -->
            <meta-data android:name="co.pokeum.linesdk.ChannelId" android:value="$S(ChannelID)" />
        </addElements>
    </androidManifestUpdates>

    <gameActivityImportAdditions>
        <insert>
            import android.content.pm.PackageManager;
            import android.os.Bundle;
            import java.util.Objects;
            import co.pokeum.linesdk.unrealwrapper.LineSdkWrapper;
        </insert>
    </gameActivityImportAdditions>

    <gameActivityClassAdditions>
        <insert>
            private static final String LINE_SDK_TAG = "LineSDK";
            
        </insert>
    </gameActivityClassAdditions>
    
    <gameActivityOnCreateAdditions>
        <insert>
            try {
                Bundle bundle = getPackageManager().getApplicationInfo(
                    getApplicationContext().getPackageName(),
                    PackageManager.GET_META_DATA
                ).metaData;
                String channelId = bundle.getString("co.pokeum.linesdk.ChannelId");
                LineSdkWrapper.setupSdk(
                    getApplicationContext(),
                    Objects.requireNonNull(channelId)
                );
            } catch (Throwable throwable) {
                android.util.Log.e(LINE_SDK_TAG, "Failed to setup Line SDK", throwable);
            }
        </insert>
    </gameActivityOnCreateAdditions>
</root>
